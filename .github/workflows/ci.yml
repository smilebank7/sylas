name: CI

on:
  push:
    branches:
      - main
      - 'cypack-*'
  pull_request:
    branches:
      - main
      - 'cypack-*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Create .env file
      run: |
        cat > .env << EOF
        LINEAR_WEBHOOK_SECRET=test
        WEBHOOK_PORT=3000
        WORKSPACE_BASE_DIR=./tmp/workspaces
        PROMPT_TEMPLATE_PATH=./examples/prompt-template.txt
        ANTHROPIC_API_KEY=test
        EOF

    - name: Run Biome
      run: bun run biome ci

    - name: Build Packages
      run: bun run build

    - name: Type Check
      run: bun run typecheck

    - name: Run Tests
      run: |
        failed=0
        for f in $(find packages apps -name '*.test.ts' -not -path '*/node_modules/*' | sort); do
          # Resolve the package directory (containing package.json) for this test file
          pkg_dir="$f"
          while [ "$pkg_dir" != "." ] && [ ! -f "$pkg_dir/package.json" ]; do
            pkg_dir=$(dirname "$pkg_dir")
          done
          # Run test from its package directory so bunfig.toml is picked up
          rel_path=$(echo "$f" | sed "s|^$pkg_dir/||")
          if ! (cd "$pkg_dir" && bun test "./$rel_path") > /dev/null 2>&1; then
            echo "FAIL: $f"
            (cd "$pkg_dir" && bun test "./$rel_path") 2>&1 | tail -20
            failed=1
          fi
        done
        exit $failed
